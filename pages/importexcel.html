<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Import Excel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="./importexcel.css" />
  </head>

  <body>
    <!-- ===== HEADER ===== -->
    <header>
      <!-- <h2>Import Excel</h2> -->
      <div class="header-left">
        <img src="../assets/basics/app.png" alt="Logo" class="logo" />
        <!-- <span class="header-title">Danh s√°ch ng∆∞·ªùi tham gia</span> -->
      </div>

      <button class="beach-button" id="saveBtn"><span>üíæ L∆∞u</span></button>

      <div class="upload-btn-wrapper">
        <button class="btn-upload">üìÇ Excel</button>
        <input type="file" id="inputExcel" accept=".xlsx,.xls,.xlsm" />
      </div>

      <button
        class="beach-button"
        onclick="window.location.href='../index.html'"
      >
        <span>Quay th∆∞·ªüng</span>
      </button>
    </header>

    <table id="excelTable"></table>

    <div id="saveArea"></div>

    <script>
      let jsonData = [];

      const COLUMN_HEADERS = [
        "S·ªë th·∫ª t·ª´",
        "M√£ nh√¢n vi√™n",
        "T√™n nh√¢n vi√™n",
        "B·ªô ph·∫≠n",
        "Ph√≤ng ban",
        "T·ªï",
        "Ch·ª©c v·ª•",
        "Chuy√™n m√¥n",
        "Th·∫Øng gi·∫£i",
      ];

      // ===========================
      // 1) AUTO LOAD LOCALSTORAGE
      // ===========================
      window.onload = function () {
        let stored = localStorage.getItem("rewardUsers");

        if (stored) {
          jsonData = JSON.parse(stored);
          renderTableFromJSON(jsonData);

          console.log("ƒê√£ load d·ªØ li·ªáu t·ª´ localStorage!");
        }
      };

      // ===========================
      // 2) HANDLE FILE IMPORT
      // ===========================
      document
        .getElementById("inputExcel")
        .addEventListener("change", function (e) {
          let file = e.target.files[0];
          let reader = new FileReader();

          reader.onload = function () {
            let data = new Uint8Array(reader.result);
            let workbook = XLSX.read(data, { type: "array" });

            let firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            let excelRows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

            jsonData = [];

            for (let i = 2; i < excelRows.length; i++) {
              let r = excelRows[i];
              if (r.length < 2) continue;
              jsonData.push({
                RFIDCard: r[2] || "",
                UserCode: r[3] || "",
                UserName: r[4] || "",
                Department: r[5] || "",
                Section: r[6] || "",
                Team: r[7] || "",
                Position: r[8] || "",
                JobTitle: r[9] || "",
                isReward: 0,
              });
            }

            renderTableFromJSON(jsonData);
          };

          reader.readAsArrayBuffer(file);
        });

      // ===========================
      // 3) RENDER TABLE
      // ===========================
      function renderTableFromJSON(data) {
        let table = document.getElementById("excelTable");
        table.innerHTML = "";

        // Header
        let headerRow = document.createElement("tr");
        COLUMN_HEADERS.forEach((h) => {
          let th = document.createElement("th");
          th.textContent = h;
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);

        // Body
        data.forEach((item) => {
          let tr = document.createElement("tr");

          let cols = [
            item.RFIDCard,
            item.UserCode,
            item.UserName,
            item.Department,
            item.Section,
            item.Team,
            item.Position,
            item.JobTitle,
            item.isReward,
          ];

          cols.forEach((c) => {
            let td = document.createElement("td");
            td.textContent = c;
            tr.appendChild(td);
          });

          table.appendChild(tr);
        });
      }

      // ===========================
      // 4) CREATE SAVE BUTTON
      // ===========================
      document.getElementById("saveBtn").onclick = function () {
        localStorage.setItem("rewardUsers", JSON.stringify(jsonData));
        alert("ƒê√£ l∆∞u d·ªØ li·ªáu v√†o LocalStorage!");
      };
    </script>
  </body>
</html>
