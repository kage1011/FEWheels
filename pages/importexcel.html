<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Import Excel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="./importexcel.css" />
  </head>

  <body>
    <!-- ===== HEADER ===== -->
    <header>
      <!-- <h2>Import Excel</h2> -->
      <div class="header-left">
        <img src="../assets/basics/app.png" alt="Logo" class="logo" />
        <!-- <span class="header-title">Danh s√°ch ng∆∞·ªùi tham gia</span> -->
      </div>

      <button class="beach-button" id="saveBtn"><span>üíæ L∆∞u</span></button>

      <div class="upload-btn-wrapper">
        <button class="btn-upload">üìÇ Excel</button>
        <input type="file" id="inputExcel" accept=".xlsx,.xls,.xlsm" />
      </div>

      <button
        class="beach-button"
        onclick="window.location.href='../index.html'"
      >
        <span>Quay th∆∞·ªüng</span>
      </button>
    </header>

    <table id="excelTable"></table>

    <div id="saveArea"></div>

    <script>
      let jsonData = [];
      let jsonPrize = [];
      let jsonUserData = [];

      const COLUMN_HEADERS = [
        "S·ªë th·∫ª t·ª´",
        "M√£ nh√¢n vi√™n",
        "T√™n nh√¢n vi√™n",
        "B·ªô ph·∫≠n",
        "Ph√≤ng ban",
        "T·ªï",
        // "Ch·ª©c v·ª•",
        "Chuy√™n m√¥n",
        "Th·∫Øng gi·∫£i",
        "H√¨nh ·∫£nh",
      ];

      // ===========================
      // 1) AUTO LOAD LOCALSTORAGE
      // ===========================
      window.onload = async function () {
        let stored = localStorage.getItem("rewardUsers");

        // Load prizes v√† users ƒë·ªìng th·ªùi
        const [prizes, users] = await Promise.all([loadPrizes(), loadUser()]);

        jsonPrize = prizes;
        jsonUserData = users.filter((u) => u.isJoin == 1);
        if (stored) {
          jsonData = mapUserWithPrize(jsonUserData, jsonPrize);
          renderTableFromJSON(jsonData);
          console.log(jsonPrize, "prizes loaded");
          console.log("ƒê√£ load d·ªØ li·ªáu t·ª´ localStorage!");
        }
      };

      async function loadPrizes() {
        try {
          const response = await fetch("../json/gift.json"); // ƒë∆∞·ªùng d·∫´n t·ªõi file JSON
          if (!response.ok) throw new Error("Kh√¥ng th·ªÉ ƒë·ªçc file JSON");
          const prizes = await response.json();
          return prizes; // tr·∫£ v·ªÅ m·∫£ng prize
        } catch (err) {
          console.error(err);
          return [];
        }
      }
      async function loadUser() {
        try {
          // const users = await getUsersFromDB();
          const users = await getUsersFromDB();
          return users; // tr·∫£ v·ªÅ m·∫£ng user
        } catch (err) {
          console.error(err);
          return [];
        }
      }
      function mapUserWithPrize(users, prizes) {
        return users.map((user) => {
          // T√¨m prize t∆∞∆°ng ·ª©ng v·ªõi user.isReward
          const prize = prizes.find((p) => p.id == user.IsReward);
          return {
            ...user,
            prizeName: prize ? prize.name : "",
          };
        });
      }

      // ===========================
      // 2) HANDLE FILE IMPORT
      // ===========================
      document
        .getElementById("inputExcel")
        .addEventListener("change", function (e) {
          let file = e.target.files[0];
          let reader = new FileReader();

          reader.onload = function () {
            let data = new Uint8Array(reader.result);
            let workbook = XLSX.read(data, { type: "array" });

            let firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            let excelRows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

            jsonData = [];

            for (let i = 2; i < excelRows.length; i++) {
              let r = excelRows[i];
              if (r.length < 2) continue;
              jsonData.push({
                RFIDCard: r[2] || "",
                UserCode: r[3] || "",
                UserName: r[4] || "",
                Department: r[5] || "",
                Section: r[6] || "",
                Team: r[7] || "",
                Position: r[8] || "",
                JobTitle: r[9] || "",
                isReward: 0,
              });
            }

            renderTableFromJSON(jsonData);
          };

          reader.readAsArrayBuffer(file);
        });

      // ===========================
      // 3) RENDER TABLE
      // ===========================
      function renderTableFromJSON(data) {
        let table = document.getElementById("excelTable");
        table.innerHTML = "";

        // Header
        let headerRow = document.createElement("tr");
        COLUMN_HEADERS.forEach((h) => {
          let th = document.createElement("th");
          th.textContent = h;
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);

        // Body
        data.forEach((item) => {
          let tr = document.createElement("tr");

          let cols = [
            item.AttendanceCard,
            item.UserCode,
            item.UserName,
            item.Department,
            item.Section,
            item.Team,
            // item.Position,
            item.JobTitle,
            item.prizeName,
            "../assets/users/" + item.UserCode + ".JPG",
          ];

          cols.forEach((c, index) => {
            let td = document.createElement("td");
            // N·∫øu l√† c·ªôt cu·ªëi c√πng (·∫£nh) ‚Üí t·∫°o img
            if (index === cols.length - 1) {
              let img = document.createElement("img");
              img.src = c;
              img.alt = item.UserName;
              img.style.width = "50px";
              img.style.height = "60px";
              td.appendChild(img);
            } else {
              td.textContent = c;
            }
            tr.appendChild(td);
          });

          table.appendChild(tr);
        });
      }

      // ===========================
      // 4) CREATE SAVE BUTTON
      // ===========================
      document.getElementById("saveBtn").onclick = function () {
        localStorage.setItem("rewardUsers", JSON.stringify(jsonData));
        alert("ƒê√£ l∆∞u d·ªØ li·ªáu v√†o LocalStorage!");
      };

      // ===========================
      // DB Area
      // ===========================
      function openDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open("FERewardDB", 1);

          request.onupgradeneeded = function (e) {
            const db = e.target.result;
            if (!db.objectStoreNames.contains("Users")) {
              const store = db.createObjectStore("Users", {
                keyPath: "UserCode",
              });
            }
          };

          request.onsuccess = function (e) {
            resolve(e.target.result);
          };

          request.onerror = function () {
            reject("Kh√¥ng th·ªÉ m·ªü DB");
          };
        });
      }
      ///// get all User
      function getUsersFromDB() {
        return new Promise(async (resolve) => {
          const db = await openDB(); // H√†m openDB t·ª´ tr∆∞·ªõc
          const tx = db.transaction("Users", "readonly");
          const store = tx.objectStore("Users");
          console.log(store);

          const users = [];
          store.openCursor().onsuccess = function (e) {
            const cursor = e.target.result;
            if (cursor) {
              users.push(cursor.value);
              cursor.continue();
            } else {
              resolve(users);
            }
          };
        });
      }
    </script>
  </body>
</html>
