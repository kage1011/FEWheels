<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>Quay Th∆∞·ªüng Cu·ªëi NƒÉm</title>
  <link rel="stylesheet" href="./css/index.css" />
</head>

<body>
  <!-- N√∫t Import Excel -->
  <a class="import-btn" href="pages/importexcel.html">Import Excel</a>
  <!-- B·∫°n b·ªè ph·∫ßn v√≤ng quay c·ªßa b·∫°n ·ªü ƒë√¢y -->

  <header>Quay Th∆∞·ªüng Cu·ªëi NƒÉm</header>
  <div class="prize-select-box">
    <label>Ch·ªçn gi·∫£i th∆∞·ªüng:</label>
    <select id="prizeSelect" onchange="onPrizeChange()">
      <option value="">-- Ch·ªçn gi·∫£i --</option>
    </select>
  </div>
  <div class="main">
    <!-- B√™n tr√°i: H√¨nh gi·∫£i th∆∞·ªüng -->
    <div class="prizes">
      <img src="prize1.jpg" alt="Gi·∫£i th∆∞·ªüng 1" />
      <img src="prize2.jpg" alt="Gi·∫£i th∆∞·ªüng 2" />
      <img src="prize3.jpg" alt="Gi·∫£i th∆∞·ªüng 3" />
      <!-- Th√™m h√¨nh kh√°c n·∫øu mu·ªën -->
    </div>

    <!-- Gi·ªØa: M√°y gacha 6 s·ªë -->
    <!-- <div class="gacha">
      <div class="numbers">
        <div class="number" id="num1">0</div>
        <div class="number" id="num2">0</div>
        <div class="number" id="num3">0</div>
        <div class="number" id="num4">0</div>
        <div class="number" id="num5">0</div>
        <div class="number" id="num6">0</div>
      </div>
      <button class="btn-spin" onclick="spinGacha()">üé∞ Quay</button>
    </div> -->
    <div class="gacha">
      <div id="gachaRows"></div>

      <button class="btn-spin" onclick="spinGacha()">üé∞ Quay</button>
    </div>

    <!-- B√™n ph·∫£i: Danh s√°ch ng∆∞·ªùi tr√∫ng -->
    <div class="winners">
      <div class="winners-title">Ng∆∞·ªùi Tr√∫ng Gi·∫£i</div>
      <div class="winner-list" id="winnerList"></div>
    </div>
  </div>

  <script>
    // =========================
    // Load danh s√°ch ng∆∞·ªùi t·ª´ localStorage
    // =========================
    let winners = JSON.parse(localStorage.getItem("rewardUsers") || "[]");
    const winnerList = document.getElementById("winnerList");

    function renderWinners() {
      const container = document.getElementById("winnerList");
      container.innerHTML = "";

      winners
        .filter((u) => u.isReward === 0)
        .forEach((u) => {
          const item = document.createElement("div");
          item.className = "winner-item";

          item.innerHTML = `
        <div class="winner-avatar" style="background-image:url('../assets/users/${u.UserCode + ".JPG" || "020439.JPG"
            }')"></div>

        <div class="winner-info">
          <div class="name">${u.UserName}</div>
          <div class="code">M√£ NV: ${u.UserCode}</div>
          <div class="dept">Ph√≤ng ban: ${u.Department}</div>
        </div>
      `;

          container.appendChild(item);
        });
    }

    renderWinners();

    // =========================
    // Quay Gacha 6 s·ªë t·ª´ 0-6
    // =========================
    async function spinGacha() {
      // 1. L·∫•y danh s√°ch t·∫•t c·∫£ user
      const users = await getUsersFromDB();

      // 2. L·ªçc danh s√°ch user ch∆∞a tr√∫ng
      const availableUsers = users.filter(
        (u) => u.IsReward == 0 && u.isJoin == 1
      );
      if (availableUsers.length === 0) {
        alert("T·∫•t c·∫£ ng∆∞·ªùi ch∆°i ƒë√£ tr√∫ng th∆∞·ªüng!");
        return;
      }

      // 3. Ch·ªçn ng·∫´u nhi√™n 1 user
      const randomIndex = Math.floor(Math.random() * availableUsers.length);
      const winner = availableUsers[randomIndex];

      for (let i = 0; i < 6; i++) {
        const num = charAtSafe(winner.UserCode, i);
        console.log(num.toString());
        document.getElementById("num" + (i + 1)).textContent = num.toString();
      }

      // 5. Update isReward = 1 trong DB
      // winner.IsReward = 1;
      // await updateUserInDB(winner);

      console.log("User ƒë√£ tr√∫ng:", winner);
    }
    function charAtSafe(str, i) {
      if (!str) return "";
      if (i < 0 || i >= str.length) return "";
      return str.charAt(i);
    }
    // =========================
    // INDEX BD -------------------------------
    // =========================

    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("FERewardDB", 1);

        request.onupgradeneeded = function (e) {
          const db = e.target.result;
          if (!db.objectStoreNames.contains("Users")) {
            const store = db.createObjectStore("Users", {
              keyPath: "UserCode",
            });
          }
        };

        request.onsuccess = function (e) {
          resolve(e.target.result);
        };

        request.onerror = function () {
          reject("Kh√¥ng th·ªÉ m·ªü DB");
        };
      });
    }
    // Check User have data or not
    function checkUserCount(db) {
      return new Promise((resolve) => {
        const tx = db.transaction("Users", "readonly");
        const store = tx.objectStore("Users");
        const req = store.count();

        req.onsuccess = () => resolve(req.result);
        req.onerror = () => resolve(0);
      });
    }
    //read json file
    async function loadUserJson() {
      const res = await fetch("../json/user.json");
      return await res.json();
    }
    // Save user data to DB
    function saveUsersToDB(db, users) {
      return new Promise((resolve) => {
        const tx = db.transaction("Users", "readwrite");
        const store = tx.objectStore("Users");

        users.forEach((user) => store.put(user));

        tx.oncomplete = () => resolve(true);
      });
    }
    async function initializeUsers() {
      const db = await openDB();
      const count = await checkUserCount(db);
      if (count > 0) {
        console.log("DB ƒë√£ c√≥ d·ªØ li·ªáu, kh√¥ng import t·ª´ JSON");
        return;
      }
      console.log("DB ch∆∞a c√≥ d·ªØ li·ªáu ‚Üí ƒê·ªçc user.json...");
      const users = await loadUserJson();
      await saveUsersToDB(db, users);
      console.log("ƒê√£ import JSON v√†o IndexedDB th√†nh c√¥ng!");
    }
    window.onload = function () {
      initializeUsers();
    };

    // Update,Delete,get
    ///// get all User
    function getUsersFromDB() {
      return new Promise(async (resolve) => {
        const db = await openDB(); // H√†m openDB t·ª´ tr∆∞·ªõc
        const tx = db.transaction("Users", "readonly");
        const store = tx.objectStore("Users");

        const users = [];
        store.openCursor().onsuccess = function (e) {
          const cursor = e.target.result;
          if (cursor) {
            users.push(cursor.value);
            cursor.continue();
          } else {
            resolve(users);
          }
        };
      });
    }
    ///// update User
    function updateUserInDB(user) {
      return new Promise(async (resolve) => {
        const db = await openDB();
        const tx = db.transaction("Users", "readwrite");
        const store = tx.objectStore("Users");
        store.put(user); // put s·∫Ω insert ho·∫∑c update
        tx.oncomplete = () => resolve(true);
      });
    }
    function renderGachaRows(slotCount) {
      const container = document.getElementById("gachaRows");
      container.innerHTML = "";

      for (let row = 0; row < slotCount; row++) {
        const div = document.createElement("div");
        div.className = "numbers-row";

        let html = "";
        for (let i = 1; i <= 6; i++) {
          html += `<div class="number" id="num_${row}_${i}">0</div>`;
        }

        div.innerHTML = html;
        container.appendChild(div);
      }
    }
    function onPrizeChange() {
      const id = document.getElementById("prizeSelect").value;
      selectedPrize = prizeList.find((p) => p.id == id);

      if (!selectedPrize) return;

      renderGachaRows(selectedPrize.slot);
    }
    async function spinGacha() {
      if (!selectedPrize) {
        alert("Vui l√≤ng ch·ªçn gi·∫£i th∆∞·ªüng tr∆∞·ªõc!");
        return;
      }

      const users = await getUsersFromDB();
      console.log(users);
      // L·ªçc user h·ª£p l·ªá
      const availableUsers = users.filter(
        (u) => u.IsReward == 0 && u.isJoin == 1
      );

      if (availableUsers.length === 0) {
        alert("Kh√¥ng c√≤n ng∆∞·ªùi n√†o ƒë·ªß ƒëi·ªÅu ki·ªán quay!");
        return;
      }

      // Random 1 user
      const winner = availableUsers[Math.floor(Math.random() * availableUsers.length)];

      // ‚Üí Hi·ªÉn th·ªã code cho t·∫•t c·∫£ h√†ng
      for (let row = 0; row < selectedPrize.slot; row++) {
        for (let i = 1; i <= 6; i++) {
          const digit = winner.UserCode[i - 1] ?? "0";
          document.getElementById(`num_${row}_${i}`).textContent = digit;
        }
      }

      // C·∫≠p nh·∫≠t tr·∫°ng th√°i tr√∫ng
      // winner.isReward = 1;
      // await updateUserInDB(winner);

      console.log("Winner:", winner);
    }
  </script>
  <script src="./js/spin.js"></script>
</body>

</html>